using System.IO;
using System.Numerics;
using System.Threading.Tasks;

namespace AsynchronousDebugging.Collatz
{
	// http://en.wikipedia.org/wiki/Collatz_conjecture#Statement_of_the_problem
	public static class CollatzConjecture
	{
		// This number will cause a StackOverflowException ONLY under the debugger in release mode:
		public static readonly string NumberThatWillCauseStackOverflowInReleaseUnderDebugger = "1675945795495912821987219289721968712867212821687615879154792512715987591782179156875589721278921971597891579129475158791297291297519471572975971278951975195791298751958791297519751587921972198752175239781392392571278167594579549591282198721928972196871286721282168761587915479251271598759178217915687558972127892197159789157912947515879129729129751947157297597127895197519579129875195879129751975158792197219875217523978139239257127816759457954959128219872192897219687128672128216876158791547925127159875917821791568755897212789219715978915791294751587912972912975194715729759712789519751957912987519587912975197515879219721987521752397813923925712781675945795495912821987219289721968712867212821687615879154792512715987591782179156875589721278921971597891579129475158791297291297519471572975971278951975195791298751958791297519751587921972198752175239781392392571278167594579549591282198721928972196871286721282168761587915479251271598759178217915687558972127892197159789157912947515879129729129751947157297597127895197519579129875195879129751975158792197219875217523978139239257127816759457954959128219872192897219";
		// This number will cause a StackOverflowException no matter what:
		public static readonly string NumberThatWillAlwaysCauseStackOverflow = "16759457954959128219872192897219687128672128216876158791547925127159875917821791568755897212789219715978915791294751587912972912975194715729759712789519751957912987519587912975197515879219721987521752397813923925712781675945795495912821987219289721968712867212821687615879154792512715987591782179156875589721278921971597891579129475158791297291297519471572975971278951975195791298751958791297519751587921972198752175239781392392571278167594579549591282198721928972196871286721282168761587915479251271598759178217915687558972127892197159789157912947515879129729129751947157297597127895197519579129875195879129751975158792197219875217523978139239257127816759457954959128219872192897219687128672128216876158791547925127159875917821791568755897212789219715978915791294751587912972912975194715729759712789519751957912987519587912975197515879219721987521752397813923925712781675945795495912821987219289721968712867212821687615879154792512715987591782179156875589721278921971597891579129475158791297291297519471572975971278951975195791298751958791297519751587921972198752175239781392392571278167594579549591282198721928972191675945795495912821987219289721968712867212821687615879154792512715987591782179156875589721278921971597891579129475158791297291297519471572975971278951975195791298751958791297519751587921972198752175239781392392571278167594579549591282198721928972196871286721282168761587915479251271598759178217915687558972127892197159789157912947515879129729129751947157297597127895197519579129875195879129751975158792197219875217523978139239257127816759457954959128219872192897219687128672128216876158791547925127159875917821791568755897212789219715978915791294751587912972912975194715729759712789519751957912987519587912975197515879219721987521752397813923925712781675945795495912821987219289721968712867212821687615879154792512715987591782179156875589721278921971597891579129475158791297291297519471572975971278951975195791298751958791297519751587921972198752175239781392392571278167594579549591282198721928972196871286721282168761587915479251271598759178217915687558972127892197159789157912947515879129729129751947157297597127895197519579129875195879129751975158792197219875217523978139239257127816759457954959128219872192897219";
		// This number should be safe to use:
		public static readonly string NumberThatIsLargeButSafe = "7893174893174893174931871";

		private static BigInteger GetNextValue(BigInteger value)
		{
			return value % 2 == 0 ?
				value / 2 : (3 * value) + 1;
		}

		public static int Collatz(BigInteger value)
		{
			var iterations = 1;

			return value > 1 ?
				iterations + CollatzConjecture.Collatz(
					CollatzConjecture.GetNextValue(value)) : 0;
		}

		public static void Collatz(BigInteger value, TextWriter writer)
		{
			writer.WriteLine(value.ToString());

			if (value > 1)
			{
				CollatzConjecture.Collatz(
					CollatzConjecture.GetNextValue(value), writer);
			}
		}

		public static async Task CollatzFromSyncToAsync(BigInteger value, TextWriter writer)
		{
			await Task.Run(async () =>
			{
				writer.WriteLine(value.ToString());

				if (value > 1)
				{
					await CollatzConjecture.CollatzFromSyncToAsync(
						CollatzConjecture.GetNextValue(value), writer);
				}
			});
		}

		public static async void CollatzReturningVoidAsync(BigInteger value, Stream stream)
		{
			var valueInBytes = value.ToByteArray();
			await stream.WriteAsync(valueInBytes, 0, valueInBytes.Length);

			if (value > 1)
			{
				CollatzConjecture.CollatzReturningVoidAsync(
					CollatzConjecture.GetNextValue(value), stream);
			}
		}

		public static async Task CollatzAsync(BigInteger value, TextWriter writer)
		{
			await writer.WriteLineAsync(value.ToString());

			if (value > 1)
			{
				await CollatzConjecture.CollatzAsync(
					CollatzConjecture.GetNextValue(value), writer);
			}
		}

		public static async Task CollatzAsync(BigInteger value, Stream stream)
		{
			var valueInBytes = value.ToByteArray();
			await stream.WriteAsync(valueInBytes, 0, valueInBytes.Length);

			if (value > 1)
			{
				await CollatzConjecture.CollatzAsync(
					CollatzConjecture.GetNextValue(value), stream);
			}
		}
	}
}
